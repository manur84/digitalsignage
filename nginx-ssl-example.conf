# ===============================================================
# Digital Signage - Nginx Reverse Proxy with SSL Configuration
# ===============================================================
#
# This configuration shows how to use nginx as a reverse proxy
# for SSL/TLS termination in production environments.
#
# Benefits of using nginx for SSL:
# - Industry-standard approach (simpler than Windows netsh)
# - Works on all platforms (Windows, Linux, macOS)
# - Better performance and scalability
# - Free Let's Encrypt SSL certificates
# - No need for Administrator privileges
# - Easier certificate management
#
# Installation:
#   Ubuntu/Debian: sudo apt install nginx
#   CentOS/RHEL:   sudo yum install nginx
#   Windows:       Download from https://nginx.org/en/download.html
#
# Usage:
#   1. Copy this file to /etc/nginx/sites-available/digitalsignage
#   2. Customize server_name and SSL certificate paths
#   3. Enable site: sudo ln -s /etc/nginx/sites-available/digitalsignage /etc/nginx/sites-enabled/
#   4. Test config: sudo nginx -t
#   5. Reload nginx: sudo systemctl reload nginx
#
# ===============================================================

# Upstream servers
upstream digitalsignage_websocket {
    server 127.0.0.1:8080;  # WebSocket server (HTTP)
    keepalive 64;
}

upstream digitalsignage_api {
    server 127.0.0.1:5001;  # REST API server (HTTP)
    keepalive 32;
}

# HTTPS Server - Main configuration
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;

    server_name digitalsignage.example.com;  # CHANGE THIS to your domain

    # =====================================
    # SSL/TLS Configuration
    # =====================================

    # SSL certificate and key paths
    # For Let's Encrypt (recommended free SSL):
    ssl_certificate     /etc/letsencrypt/live/digitalsignage.example.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/digitalsignage.example.com/privkey.pem;

    # For self-signed certificate (development only):
    # ssl_certificate     /opt/digitalsignage-server/certs/server.crt;
    # ssl_certificate_key /opt/digitalsignage-server/certs/server.key;

    # Modern SSL configuration (strong security)
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers 'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384';
    ssl_prefer_server_ciphers off;

    # SSL session optimization
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;
    ssl_session_tickets off;

    # OCSP stapling
    ssl_stapling on;
    ssl_stapling_verify on;
    resolver 8.8.8.8 8.8.4.4 valid=300s;
    resolver_timeout 5s;

    # Security headers
    add_header Strict-Transport-Security "max-age=63072000; includeSubDomains; preload" always;
    add_header X-Frame-Options DENY always;
    add_header X-Content-Type-Options nosniff always;
    add_header X-XSS-Protection "1; mode=block" always;

    # =====================================
    # WebSocket Proxy (WSS)
    # =====================================

    location /ws/ {
        proxy_pass http://digitalsignage_websocket/ws/;

        # WebSocket upgrade headers
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";

        # Proxy headers
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Timeouts for long-lived connections
        proxy_connect_timeout 7d;
        proxy_send_timeout 7d;
        proxy_read_timeout 7d;

        # Disable buffering for WebSocket
        proxy_buffering off;

        # Access log for WebSocket connections
        access_log /var/log/nginx/digitalsignage-ws-access.log;
        error_log /var/log/nginx/digitalsignage-ws-error.log;
    }

    # =====================================
    # REST API Proxy (HTTPS)
    # =====================================

    location /api/ {
        proxy_pass http://digitalsignage_api/api/;

        # HTTP/1.1 for REST API
        proxy_http_version 1.1;
        proxy_set_header Connection "";

        # Proxy headers
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Request body limits for file uploads (screenshots, media)
        client_max_body_size 50M;

        # Timeouts
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;

        # Enable keepalive
        proxy_set_header Connection "keep-alive";

        # Access log for API requests
        access_log /var/log/nginx/digitalsignage-api-access.log;
        error_log /var/log/nginx/digitalsignage-api-error.log;
    }

    # =====================================
    # Swagger UI (Optional - for development)
    # =====================================

    location /swagger/ {
        proxy_pass http://digitalsignage_api/swagger/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
    }

    # =====================================
    # Static Files (Optional - if needed)
    # =====================================

    # location /static/ {
    #     alias /opt/digitalsignage-server/wwwroot/;
    #     expires 1y;
    #     add_header Cache-Control "public, immutable";
    # }

    # =====================================
    # Health Check Endpoint
    # =====================================

    location /health {
        proxy_pass http://digitalsignage_api/api/health;
        proxy_http_version 1.1;
        access_log off;
    }
}

# =====================================
# HTTP to HTTPS Redirect
# =====================================

server {
    listen 80;
    listen [::]:80;

    server_name digitalsignage.example.com;  # CHANGE THIS to your domain

    # ACME challenge for Let's Encrypt (for certificate renewal)
    location /.well-known/acme-challenge/ {
        root /var/www/letsencrypt;
        allow all;
    }

    # Redirect all HTTP traffic to HTTPS
    location / {
        return 301 https://$server_name$request_uri;
    }
}

# ===============================================================
# Let's Encrypt SSL Certificate Setup (Recommended)
# ===============================================================
#
# 1. Install Certbot:
#    sudo apt install certbot python3-certbot-nginx
#
# 2. Obtain SSL certificate:
#    sudo certbot --nginx -d digitalsignage.example.com
#
# 3. Auto-renewal (certbot creates cron job automatically):
#    sudo certbot renew --dry-run
#
# 4. Certificate files will be stored in:
#    /etc/letsencrypt/live/digitalsignage.example.com/
#
# ===============================================================

# ===============================================================
# Self-Signed Certificate (Development Only)
# ===============================================================
#
# Generate self-signed certificate for testing:
#
#   sudo mkdir -p /opt/digitalsignage-server/certs
#   sudo openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
#     -keyout /opt/digitalsignage-server/certs/server.key \
#     -out /opt/digitalsignage-server/certs/server.crt \
#     -subj "/CN=digitalsignage.example.com"
#
# WARNING: Self-signed certificates will show browser warnings
# and are NOT suitable for production use!
#
# ===============================================================

# ===============================================================
# Testing the Configuration
# ===============================================================
#
# 1. Test nginx configuration:
#    sudo nginx -t
#
# 2. Reload nginx:
#    sudo systemctl reload nginx
#
# 3. Test WebSocket connection (from client):
#    Change client config to use:
#    - server_host: digitalsignage.example.com
#    - server_port: 443
#    - use_ssl: true
#
# 4. Test REST API:
#    curl https://digitalsignage.example.com/api/health
#
# 5. Monitor logs:
#    sudo tail -f /var/log/nginx/digitalsignage-*-access.log
#    sudo tail -f /var/log/nginx/digitalsignage-*-error.log
#
# ===============================================================

# ===============================================================
# Client Configuration for nginx SSL
# ===============================================================
#
# Raspberry Pi Client (config.json):
# {
#   "server_host": "digitalsignage.example.com",
#   "server_port": 443,
#   "use_ssl": true,
#   "verify_ssl": true
# }
#
# Mobile App Configuration:
# - Server URL: https://digitalsignage.example.com
# - WebSocket URL: wss://digitalsignage.example.com/ws/
#
# ===============================================================
