<UserControl x:Class="DigitalSignage.Server.Views.DataSources.DataSourcesTabControl"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:local="clr-namespace:DigitalSignage.Server.Views"
             xmlns:converters="clr-namespace:DigitalSignage.Server.Converters"
             mc:Ignorable="d"
             d:DesignHeight="600" d:DesignWidth="1000">
    <Grid>
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="250"/>
            <ColumnDefinition Width="*"/>
        </Grid.ColumnDefinitions>

        <!-- Data Source List -->
        <Border Grid.Column="0" Background="White" BorderBrush="#CCCCCC" BorderThickness="0,0,1,0">
            <DockPanel>
                <StackPanel DockPanel.Dock="Top" Margin="8">
                    <Button Content="Add Data Source"
                            Command="{Binding DataSourceViewModel.AddDataSourceCommand}"
                            Style="{StaticResource PrimaryButton}"
                            Margin="0,0,0,4"/>
                    <Button Content="Add Static Data Source"
                            Command="{Binding DataSourceViewModel.AddStaticDataSourceCommand}"
                            Style="{StaticResource SecondaryButton}"
                            Margin="0,0,0,8"/>
                </StackPanel>
                <ListBox ItemsSource="{Binding DataSourceViewModel.DataSources}"
                         SelectedItem="{Binding DataSourceViewModel.SelectedDataSource}"
                         DisplayMemberPath="Name"
                         Margin="8,0"/>
            </DockPanel>
        </Border>

        <!-- Data Source Editor -->
        <ScrollViewer Grid.Column="1">
            <StackPanel Margin="16">
                <TextBlock Text="Data Source Configuration" FontSize="20" FontWeight="Bold" Margin="0,0,0,16"/>

                <!-- Show when no data source is selected -->
                <TextBlock Text="No data source selected. Click 'Add Data Source' or 'Add Static Data Source' to begin."
                          Foreground="Gray"
                          Margin="0,8"
                          TextWrapping="Wrap">
                    <TextBlock.Visibility>
                        <Binding Path="DataSourceViewModel.SelectedDataSource">
                            <Binding.Converter>
                                <converters:NullToVisibilityConverter/>
                            </Binding.Converter>
                        </Binding>
                    </TextBlock.Visibility>
                </TextBlock>

                <!-- Show when data source is selected -->
                <StackPanel>
                    <StackPanel.Visibility>
                        <Binding Path="DataSourceViewModel.SelectedDataSource">
                            <Binding.Converter>
                                <converters:NullToVisibilityConverter Invert="True"/>
                            </Binding.Converter>
                        </Binding>
                    </StackPanel.Visibility>

                    <TextBlock Text="Name:" Margin="0,8,0,4"/>
                    <TextBox Text="{Binding DataSourceViewModel.SelectedDataSource.Name, UpdateSourceTrigger=PropertyChanged}"/>

                    <TextBlock Text="Type:" Margin="0,12,0,4"/>
                    <CheckBox Content="Use Static Data (for testing)"
                              IsChecked="{Binding DataSourceViewModel.IsStaticDataSource}"
                              Margin="0,4"/>

                    <!-- Static Data Section (visible when IsStaticDataSource is true) -->
                    <StackPanel Visibility="{Binding DataSourceViewModel.IsStaticDataSource, Converter={StaticResource BooleanToVisibilityConverter}}">
                        <TextBlock Text="Static Data (JSON):" Margin="0,12,0,4" FontWeight="SemiBold"/>
                        <TextBlock Text="Example: { &quot;room_name&quot;: &quot;Conference Room A&quot;, &quot;status&quot;: &quot;Available&quot;, &quot;temperature&quot;: &quot;22Â°C&quot; }"
                                  Foreground="Gray"
                                  FontSize="11"
                                  Margin="0,0,0,4"
                                  TextWrapping="Wrap"/>
                        <TextBox Text="{Binding DataSourceViewModel.StaticDataJson, UpdateSourceTrigger=PropertyChanged}"
                                Height="200"
                                TextWrapping="Wrap"
                                AcceptsReturn="True"
                                FontFamily="Consolas"
                                FontSize="12"
                                VerticalScrollBarVisibility="Auto"/>
                    </StackPanel>

                    <!-- SQL Database Section (visible when IsStaticDataSource is false) -->
                    <StackPanel Visibility="{Binding DataSourceViewModel.IsStaticDataSource, Converter={StaticResource InverseBooleanToVisibilityConverter}}">
                        <TextBlock Text="Connection String:" Margin="0,12,0,4"/>
                        <TextBox Text="{Binding DataSourceViewModel.SelectedDataSource.ConnectionString, UpdateSourceTrigger=PropertyChanged}"
                                Height="60"
                                TextWrapping="Wrap"
                                AcceptsReturn="True"/>

                        <TextBlock Text="Query:" Margin="0,12,0,4"/>
                        <TextBox Text="{Binding DataSourceViewModel.SelectedDataSource.Query, UpdateSourceTrigger=PropertyChanged}"
                                Height="120"
                                TextWrapping="Wrap"
                                AcceptsReturn="True"
                                FontFamily="Consolas"/>

                        <!-- Query Builder Section -->
                        <Border Background="#F8F8F8"
                                BorderBrush="#DDDDDD"
                                BorderThickness="1"
                                CornerRadius="4"
                                Padding="12"
                                Margin="0,16,0,0">
                            <StackPanel>
                                <TextBlock Text="Visual Query Builder" FontWeight="SemiBold" FontSize="14" Margin="0,0,0,12"/>
                                <TextBlock Text="Build SQL queries visually. Generated query will be applied to the Query field above."
                                          FontSize="11"
                                          Foreground="#666666"
                                          TextWrapping="Wrap"
                                          Margin="0,0,0,12"/>

                                <!-- Table Name -->
                                <TextBlock Text="Table Name:" Margin="0,0,0,4"/>
                                <DockPanel Margin="0,0,0,8">
                                    <TextBox Text="{Binding DataSourceViewModel.QueryTableName, UpdateSourceTrigger=PropertyChanged}"
                                            ToolTip="Enter the name of the database table"
                                            DockPanel.Dock="Left"
                                            MinWidth="220"/>
                                    <Button Content="Load Columns"
                                            Command="{Binding DataSourceViewModel.LoadColumnsForTableCommand}"
                                            Margin="8,0,0,0"
                                            IsEnabled="{Binding DataSourceViewModel.IsLoadingColumns, Converter={StaticResource InverseBooleanConverter}}"
                                            Style="{StaticResource SecondaryButton}"/>
                                </DockPanel>

                                <!-- Columns + Picker -->
                                <TextBlock Text="Columns:" Margin="0,0,0,4"/>
                                <DockPanel>
                                    <TextBox Text="{Binding DataSourceViewModel.QueryColumns, UpdateSourceTrigger=PropertyChanged}"
                                            ToolTip="Enter column names separated by commas, or * for all columns"
                                            DockPanel.Dock="Left"
                                            MinWidth="220"/>
                                    <ComboBox ItemsSource="{Binding DataSourceViewModel.AvailableColumns}"
                                              SelectedItem="{Binding DataSourceViewModel.SelectedAvailableColumn}"
                                              Width="200"
                                              Margin="8,0,0,0"/>
                                    <Button Content="Add"
                                            Command="{Binding DataSourceViewModel.AddSelectedColumnCommand}"
                                            Margin="8,0,0,0"
                                            Style="{StaticResource SecondaryButton}"/>
                                    <Button Content="Add all"
                                            Command="{Binding DataSourceViewModel.AddAllColumnsCommand}"
                                            Margin="8,0,0,0"
                                            Style="{StaticResource SecondaryButton}"/>
                                </DockPanel>

                                <!-- WHERE Clause -->
                                <TextBlock Text="WHERE Clause (optional):" Margin="0,8,0,4"/>
                                <TextBox Text="{Binding DataSourceViewModel.QueryWhereClause, UpdateSourceTrigger=PropertyChanged}"
                                        ToolTip="Example: status = 'active' AND created_at > '2024-01-01'"/>

                                <!-- ORDER BY -->
                                <TextBlock Text="ORDER BY (optional):" Margin="0,8,0,4"/>
                                <TextBox Text="{Binding DataSourceViewModel.QueryOrderBy, UpdateSourceTrigger=PropertyChanged}"
                                        ToolTip="Example: created_at DESC, name ASC"/>

                                <!-- Generate Button -->
                                <Button Content="Generate Query"
                                       Command="{Binding DataSourceViewModel.GenerateQueryCommand}"
                                       Style="{StaticResource PrimaryButton}"
                                       HorizontalAlignment="Left"
                                       Padding="20,8"
                                       Margin="0,12,0,0"/>

                                <!-- Generated Query Preview -->
                                <TextBlock Text="Generated Query:" Margin="0,16,0,4" FontWeight="SemiBold"/>
                                <TextBox Text="{Binding DataSourceViewModel.GeneratedQuery, Mode=OneWay}"
                                        Height="100"
                                        IsReadOnly="True"
                                        Background="#EEEEEE"
                                        FontFamily="Consolas"
                                        FontSize="12"
                                        TextWrapping="Wrap"
                                        VerticalScrollBarVisibility="Auto"/>
                            </StackPanel>
                        </Border>
                    </StackPanel>

                    <TextBlock Text="Refresh Interval (seconds):" Margin="0,12,0,4"/>
                    <TextBox Text="{Binding DataSourceViewModel.SelectedDataSource.RefreshInterval, UpdateSourceTrigger=PropertyChanged}"/>

                    <!-- Test Result -->
                    <TextBlock Text="{Binding DataSourceViewModel.TestResult}"
                              Margin="0,12,0,0"
                              FontWeight="SemiBold"
                              Foreground="{Binding DataSourceViewModel.TestResult, Converter={StaticResource TestResultToColorConverter}}"
                              TextWrapping="Wrap"/>

                    <StackPanel Orientation="Horizontal" Margin="0,16,0,0">
                        <Button Content="Test Connection"
                                Command="{Binding DataSourceViewModel.TestConnectionCommand}"
                                Style="{StaticResource PrimaryButton}"
                                Margin="0,0,8,0"
                                IsEnabled="{Binding DataSourceViewModel.IsTesting, Converter={StaticResource InverseBooleanConverter}}"/>
                        <Button Content="Save"
                                Command="{Binding DataSourceViewModel.SaveDataSourceCommand}"
                                Style="{StaticResource PrimaryButton}"
                                Margin="0,0,8,0"/>
                        <Button Content="Delete"
                                Command="{Binding DataSourceViewModel.DeleteDataSourceCommand}"
                                Style="{StaticResource SecondaryButton}"/>
                    </StackPanel>
                </StackPanel>
            </StackPanel>
        </ScrollViewer>
    </Grid>
</UserControl>
