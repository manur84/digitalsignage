<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:DigitalSignage.App.Mobile.ViewModels"
             x:Class="DigitalSignage.App.Mobile.Views.DeviceDetailPage"
             x:DataType="vm:DeviceDetailViewModel"
             Title="{Binding Title}"
             BackgroundColor="{DynamicResource Background}">

    <Grid>
        <!-- Loading Overlay -->
        <BoxView IsVisible="{Binding IsBusy}"
                 BackgroundColor="Black"
                 Opacity="0.5"
                 ZIndex="100"/>

        <ActivityIndicator IsRunning="{Binding IsBusy}"
                          IsVisible="{Binding IsBusy}"
                          Color="{DynamicResource Primary}"
                          HorizontalOptions="Center"
                          VerticalOptions="Center"
                          ZIndex="101"
                          WidthRequest="50"
                          HeightRequest="50"/>

        <!-- Main Content with Tabs -->
        <Grid RowDefinitions="Auto,*" IsVisible="{Binding IsBusy, Converter={StaticResource InvertedBoolConverter}}">

            <!-- Device Header -->
            <Frame Grid.Row="0"
                   Margin="16,16,16,12"
                   Padding="20"
                   BackgroundColor="{DynamicResource Surface}"
                   BorderColor="{DynamicResource Gray200}"
                   CornerRadius="12"
                   HasShadow="False">
                <Grid RowDefinitions="Auto,Auto,Auto" ColumnDefinitions="*,Auto" RowSpacing="12">
                    <Label Grid.Row="0" Grid.ColumnSpan="2"
                           Text="{Binding Device.Name}"
                           FontSize="24"
                           FontAttributes="Bold"
                           TextColor="{DynamicResource Gray900}"/>

                    <VerticalStackLayout Grid.Row="1" Grid.Column="0" Spacing="6">
                        <Label Text="{Binding Device.IpAddress, StringFormat='IP: {0}'}"
                               FontSize="14"
                               TextColor="{DynamicResource Gray600}"/>
                        <Label Text="{Binding Device.Resolution, StringFormat='Resolution: {0}'}"
                               FontSize="14"
                               TextColor="{DynamicResource Gray600}"/>
                        <Label Text="{Binding Device.LastSeen, StringFormat='Last Seen: {0:HH:mm:ss}'}"
                               FontSize="13"
                               TextColor="{DynamicResource Gray500}"/>
                    </VerticalStackLayout>

                    <VerticalStackLayout Grid.Row="1" Grid.Column="1"
                                        VerticalOptions="Center"
                                        HorizontalOptions="End"
                                        Spacing="6">
                        <Label Text="{Binding Device.Status}"
                               FontSize="16"
                               FontAttributes="Bold"
                               TextColor="{Binding StatusColor}"
                               HorizontalOptions="End"/>
                        <BoxView HeightRequest="12"
                                WidthRequest="12"
                                CornerRadius="6"
                                BackgroundColor="{Binding StatusColor}"
                                HorizontalOptions="End"/>
                    </VerticalStackLayout>
                </Grid>
            </Frame>

            <!-- Tabbed Content -->
            <ScrollView Grid.Row="1">
                <VerticalStackLayout Padding="16,8" Spacing="16">

                    <!-- Hardware Metrics Section -->
                    <Frame Padding="20"
                           BackgroundColor="{DynamicResource Surface}"
                           BorderColor="{DynamicResource Gray200}"
                           CornerRadius="12"
                           HasShadow="False">
                        <VerticalStackLayout Spacing="18">
                            <Label Text="Hardware Metrics"
                                   FontSize="20"
                                   FontAttributes="Bold"
                                   TextColor="{DynamicResource Gray900}"/>

                            <!-- CPU Usage -->
                            <VerticalStackLayout Spacing="6">
                                <Grid ColumnDefinitions="*,Auto">
                                    <Label Text="CPU Usage"
                                           FontSize="14"
                                           TextColor="{DynamicResource Gray600}"/>
                                    <Label Grid.Column="1"
                                           Text="{Binding CpuUsagePercent, StringFormat='{0:P0}'}"
                                           FontSize="14"
                                           FontAttributes="Bold"
                                           TextColor="{DynamicResource Primary}"/>
                                </Grid>
                                <ProgressBar Progress="{Binding CpuUsagePercent}"
                                            ProgressColor="{DynamicResource Primary}"
                                            HeightRequest="8"/>
                            </VerticalStackLayout>

                            <!-- Memory Usage -->
                            <VerticalStackLayout Spacing="6">
                                <Grid ColumnDefinitions="*,Auto">
                                    <Label Text="Memory Usage"
                                           FontSize="14"
                                           TextColor="{DynamicResource Gray600}"/>
                                    <Label Grid.Column="1"
                                           Text="{Binding MemoryUsagePercent, StringFormat='{0:P0}'}"
                                           FontSize="14"
                                           FontAttributes="Bold"
                                           TextColor="{DynamicResource Primary}"/>
                                </Grid>
                                <ProgressBar Progress="{Binding MemoryUsagePercent}"
                                            ProgressColor="{DynamicResource Primary}"
                                            HeightRequest="8"/>
                            </VerticalStackLayout>

                            <!-- Disk Usage -->
                            <VerticalStackLayout Spacing="6">
                                <Grid ColumnDefinitions="*,Auto">
                                    <Label Text="Disk Usage"
                                           FontSize="14"
                                           TextColor="{DynamicResource Gray600}"/>
                                    <Label Grid.Column="1"
                                           Text="{Binding DiskUsagePercent, StringFormat='{0:P0}'}"
                                           FontSize="14"
                                           FontAttributes="Bold"
                                           TextColor="{DynamicResource Tertiary}"/>
                                </Grid>
                                <ProgressBar Progress="{Binding DiskUsagePercent}"
                                            ProgressColor="{DynamicResource Tertiary}"
                                            HeightRequest="8"/>
                            </VerticalStackLayout>

                            <!-- Temperature -->
                            <Grid ColumnDefinitions="*,Auto">
                                <Label Text="Temperature"
                                       FontSize="14"
                                       TextColor="{DynamicResource Gray600}"
                                       VerticalOptions="Center"/>
                                <Label Grid.Column="1"
                                       Text="{Binding TemperatureText}"
                                       FontSize="18"
                                       FontAttributes="Bold"
                                       TextColor="{Binding TemperatureColor}"/>
                            </Grid>

                            <!-- Device Info -->
                            <BoxView HeightRequest="1"
                                    BackgroundColor="{DynamicResource Gray200}"
                                    Margin="0,4"/>

                            <Grid ColumnDefinitions="Auto,*" RowDefinitions="Auto,Auto" RowSpacing="10">
                                <Label Grid.Row="0" Grid.Column="0"
                                       Text="OS Version:"
                                       FontSize="14"
                                       TextColor="{DynamicResource Gray600}"
                                       Margin="0,0,16,0"/>
                                <Label Grid.Row="0" Grid.Column="1"
                                       Text="{Binding Device.DeviceInfo.OsVersion}"
                                       FontSize="14"
                                       TextColor="{DynamicResource Gray900}"/>

                                <Label Grid.Row="1" Grid.Column="0"
                                       Text="App Version:"
                                       FontSize="14"
                                       TextColor="{DynamicResource Gray600}"
                                       Margin="0,0,16,0"/>
                                <Label Grid.Row="1" Grid.Column="1"
                                       Text="{Binding Device.DeviceInfo.AppVersion}"
                                       FontSize="14"
                                       TextColor="{DynamicResource Gray900}"/>
                            </Grid>
                        </VerticalStackLayout>
                    </Frame>

                    <!-- Remote Controls Section -->
                    <Frame Padding="20"
                           BackgroundColor="{DynamicResource Surface}"
                           BorderColor="{DynamicResource Gray200}"
                           CornerRadius="12"
                           HasShadow="False">
                        <VerticalStackLayout Spacing="18">
                            <Label Text="Remote Controls"
                                   FontSize="20"
                                   FontAttributes="Bold"
                                   TextColor="{DynamicResource Gray900}"/>

                            <Grid RowDefinitions="Auto,Auto,Auto,Auto"
                                  ColumnDefinitions="*,*"
                                  RowSpacing="12"
                                  ColumnSpacing="12">

                                <!-- Restart Button (full width) -->
                                <Button Grid.Row="0" Grid.ColumnSpan="2"
                                        Text="Restart Device"
                                        Command="{Binding RestartCommand}"
                                        BackgroundColor="{DynamicResource Danger}"
                                        TextColor="White"
                                        FontSize="15"
                                        FontAttributes="Bold"
                                        HeightRequest="52"
                                        CornerRadius="12"/>

                                <!-- Volume Controls -->
                                <Button Grid.Row="1" Grid.Column="0"
                                        Text="Volume Up"
                                        Command="{Binding VolumeUpCommand}"
                                        BackgroundColor="{DynamicResource Primary}"
                                        TextColor="White"
                                        FontSize="15"
                                        HeightRequest="52"
                                        CornerRadius="12"/>
                                <Button Grid.Row="1" Grid.Column="1"
                                        Text="Volume Down"
                                        Command="{Binding VolumeDownCommand}"
                                        BackgroundColor="{DynamicResource Primary}"
                                        TextColor="White"
                                        FontSize="15"
                                        HeightRequest="52"
                                        CornerRadius="12"/>

                                <!-- Screen Controls -->
                                <Button Grid.Row="2" Grid.Column="0"
                                        Text="Screen On"
                                        Command="{Binding ScreenOnCommand}"
                                        BackgroundColor="{DynamicResource Secondary}"
                                        TextColor="White"
                                        FontSize="15"
                                        HeightRequest="52"
                                        CornerRadius="12"/>
                                <Button Grid.Row="2" Grid.Column="1"
                                        Text="Screen Off"
                                        Command="{Binding ScreenOffCommand}"
                                        BackgroundColor="{DynamicResource Gray600}"
                                        TextColor="White"
                                        FontSize="15"
                                        HeightRequest="52"
                                        CornerRadius="12"/>

                                <!-- Refresh Button (full width) -->
                                <Button Grid.Row="3" Grid.ColumnSpan="2"
                                        Text="Refresh Info"
                                        Command="{Binding RefreshCommand}"
                                        BackgroundColor="{DynamicResource Surface}"
                                        TextColor="{DynamicResource Primary}"
                                        BorderColor="{DynamicResource Primary}"
                                        BorderWidth="2"
                                        FontSize="15"
                                        FontAttributes="Bold"
                                        HeightRequest="52"
                                        CornerRadius="12"/>
                            </Grid>
                        </VerticalStackLayout>
                    </Frame>

                    <!-- Screenshot Section -->
                    <Frame Padding="20"
                           BackgroundColor="{DynamicResource Surface}"
                           BorderColor="{DynamicResource Gray200}"
                           CornerRadius="12"
                           HasShadow="False">
                        <VerticalStackLayout Spacing="18">
                            <Label Text="Screenshot"
                                   FontSize="20"
                                   FontAttributes="Bold"
                                   TextColor="{DynamicResource Gray900}"/>

                            <Button Text="Take Screenshot"
                                    Command="{Binding RequestScreenshotCommand}"
                                    BackgroundColor="{DynamicResource Primary}"
                                    TextColor="White"
                                    FontSize="15"
                                    FontAttributes="Bold"
                                    HeightRequest="52"
                                    CornerRadius="12"/>

                            <!-- Screenshot Loading -->
                            <ActivityIndicator IsRunning="{Binding IsLoadingScreenshot}"
                                              IsVisible="{Binding IsLoadingScreenshot}"
                                              Color="{DynamicResource Primary}"
                                              HeightRequest="50"/>

                            <!-- Screenshot Image -->
                            <Frame Padding="0"
                                   IsVisible="{Binding ScreenshotImage, Converter={StaticResource IsNotNullConverter}}"
                                   BorderColor="{DynamicResource Gray200}"
                                   CornerRadius="12"
                                   HasShadow="False">
                                <VerticalStackLayout Spacing="0">
                                    <Image Source="{Binding ScreenshotImage}"
                                           Aspect="AspectFit"
                                           HeightRequest="300"
                                           BackgroundColor="{DynamicResource Gray900}"/>
                                    <Label Text="{Binding ScreenshotTimestamp, StringFormat='Captured: {0:yyyy-MM-dd HH:mm:ss}'}"
                                           FontSize="13"
                                           TextColor="{DynamicResource Gray500}"
                                           HorizontalOptions="Center"
                                           Margin="0,12,0,12"/>
                                </VerticalStackLayout>
                            </Frame>

                            <!-- No Screenshot Placeholder -->
                            <Label Text="No screenshot available. Tap 'Take Screenshot' to capture the current screen."
                                   IsVisible="{Binding ScreenshotImage, Converter={StaticResource IsNullConverter}}"
                                   FontSize="14"
                                   TextColor="{DynamicResource Gray500}"
                                   HorizontalTextAlignment="Center"
                                   LineBreakMode="WordWrap"
                                   Margin="8"/>
                        </VerticalStackLayout>
                    </Frame>

                </VerticalStackLayout>
            </ScrollView>
        </Grid>
    </Grid>
</ContentPage>
