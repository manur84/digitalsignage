<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:DigitalSignage.App.Mobile.ViewModels"
             x:Class="DigitalSignage.App.Mobile.Views.DeviceDetailPage"
             x:DataType="vm:DeviceDetailViewModel"
             Title="{Binding Title}">

    <ContentPage.Resources>
        <ResourceDictionary>
            <!-- Colors -->
            <Color x:Key="Primary">#2196F3</Color>
            <Color x:Key="Success">#4CAF50</Color>
            <Color x:Key="Warning">#FF9800</Color>
            <Color x:Key="Danger">#F44336</Color>
            <Color x:Key="LightGray">#E0E0E0</Color>
        </ResourceDictionary>
    </ContentPage.Resources>

    <Grid>
        <!-- Loading Overlay -->
        <BoxView IsVisible="{Binding IsBusy}"
                 BackgroundColor="Black"
                 Opacity="0.5"
                 ZIndex="100"/>

        <ActivityIndicator IsRunning="{Binding IsBusy}"
                          IsVisible="{Binding IsBusy}"
                          Color="{StaticResource Primary}"
                          HorizontalOptions="Center"
                          VerticalOptions="Center"
                          ZIndex="101"
                          WidthRequest="50"
                          HeightRequest="50"/>

        <!-- Main Content with Tabs -->
        <Grid RowDefinitions="Auto,*" IsVisible="{Binding IsBusy, Converter={StaticResource InvertedBoolConverter}}">

            <!-- Device Header -->
            <Frame Grid.Row="0"
                   Margin="16,16,16,8"
                   Padding="16"
                   BackgroundColor="White"
                   BorderColor="{StaticResource Primary}"
                   CornerRadius="8"
                   HasShadow="True">
                <Grid RowDefinitions="Auto,Auto,Auto" ColumnDefinitions="*,Auto">
                    <Label Grid.Row="0" Grid.ColumnSpan="2"
                           Text="{Binding Device.Name}"
                           FontSize="24"
                           FontAttributes="Bold"
                           TextColor="Black"/>

                    <VerticalStackLayout Grid.Row="1" Grid.Column="0" Spacing="4">
                        <Label Text="{Binding Device.IpAddress, StringFormat='IP: {0}'}"
                               FontSize="14"
                               TextColor="#666"/>
                        <Label Text="{Binding Device.Resolution, StringFormat='Resolution: {0}'}"
                               FontSize="14"
                               TextColor="#666"/>
                        <Label Text="{Binding Device.LastSeen, StringFormat='Last Seen: {0:HH:mm:ss}'}"
                               FontSize="12"
                               TextColor="#999"/>
                    </VerticalStackLayout>

                    <VerticalStackLayout Grid.Row="1" Grid.Column="1"
                                        VerticalOptions="Center"
                                        HorizontalOptions="End">
                        <Label Text="{Binding Device.Status}"
                               FontSize="16"
                               FontAttributes="Bold"
                               TextColor="{Binding StatusColor}"
                               HorizontalOptions="End"/>
                        <BoxView HeightRequest="10"
                                WidthRequest="10"
                                CornerRadius="5"
                                BackgroundColor="{Binding StatusColor}"
                                HorizontalOptions="End"/>
                    </VerticalStackLayout>
                </Grid>
            </Frame>

            <!-- Tabbed Content -->
            <ScrollView Grid.Row="1">
                <VerticalStackLayout Padding="16,8" Spacing="16">

                    <!-- Hardware Metrics Section -->
                    <Frame Padding="16"
                           BackgroundColor="White"
                           BorderColor="{StaticResource LightGray}"
                           CornerRadius="8"
                           HasShadow="True">
                        <VerticalStackLayout Spacing="16">
                            <Label Text="Hardware Metrics"
                                   FontSize="20"
                                   FontAttributes="Bold"
                                   TextColor="Black"/>

                            <!-- CPU Usage -->
                            <VerticalStackLayout Spacing="4">
                                <Grid ColumnDefinitions="*,Auto">
                                    <Label Text="CPU Usage"
                                           FontSize="14"
                                           TextColor="#666"/>
                                    <Label Grid.Column="1"
                                           Text="{Binding CpuUsagePercent, StringFormat='{0:P0}'}"
                                           FontSize="14"
                                           FontAttributes="Bold"
                                           TextColor="{StaticResource Primary}"/>
                                </Grid>
                                <ProgressBar Progress="{Binding CpuUsagePercent}"
                                            ProgressColor="{StaticResource Primary}"
                                            HeightRequest="8"/>
                            </VerticalStackLayout>

                            <!-- Memory Usage -->
                            <VerticalStackLayout Spacing="4">
                                <Grid ColumnDefinitions="*,Auto">
                                    <Label Text="Memory Usage"
                                           FontSize="14"
                                           TextColor="#666"/>
                                    <Label Grid.Column="1"
                                           Text="{Binding MemoryUsagePercent, StringFormat='{0:P0}'}"
                                           FontSize="14"
                                           FontAttributes="Bold"
                                           TextColor="{StaticResource Primary}"/>
                                </Grid>
                                <ProgressBar Progress="{Binding MemoryUsagePercent}"
                                            ProgressColor="{StaticResource Primary}"
                                            HeightRequest="8"/>
                            </VerticalStackLayout>

                            <!-- Disk Usage -->
                            <VerticalStackLayout Spacing="4">
                                <Grid ColumnDefinitions="*,Auto">
                                    <Label Text="Disk Usage"
                                           FontSize="14"
                                           TextColor="#666"/>
                                    <Label Grid.Column="1"
                                           Text="{Binding DiskUsagePercent, StringFormat='{0:P0}'}"
                                           FontSize="14"
                                           FontAttributes="Bold"
                                           TextColor="{StaticResource Warning}"/>
                                </Grid>
                                <ProgressBar Progress="{Binding DiskUsagePercent}"
                                            ProgressColor="{StaticResource Warning}"
                                            HeightRequest="8"/>
                            </VerticalStackLayout>

                            <!-- Temperature -->
                            <Grid ColumnDefinitions="*,Auto">
                                <Label Text="Temperature"
                                       FontSize="14"
                                       TextColor="#666"
                                       VerticalOptions="Center"/>
                                <Label Grid.Column="1"
                                       Text="{Binding TemperatureText}"
                                       FontSize="18"
                                       FontAttributes="Bold"
                                       TextColor="{Binding TemperatureColor}"/>
                            </Grid>

                            <!-- Device Info -->
                            <BoxView HeightRequest="1"
                                    BackgroundColor="{StaticResource LightGray}"
                                    Margin="0,8"/>

                            <Grid ColumnDefinitions="Auto,*" RowDefinitions="Auto,Auto" RowSpacing="8">
                                <Label Grid.Row="0" Grid.Column="0"
                                       Text="OS Version:"
                                       FontSize="14"
                                       TextColor="#666"
                                       Margin="0,0,16,0"/>
                                <Label Grid.Row="0" Grid.Column="1"
                                       Text="{Binding Device.DeviceInfo.OsVersion}"
                                       FontSize="14"
                                       TextColor="Black"/>

                                <Label Grid.Row="1" Grid.Column="0"
                                       Text="App Version:"
                                       FontSize="14"
                                       TextColor="#666"
                                       Margin="0,0,16,0"/>
                                <Label Grid.Row="1" Grid.Column="1"
                                       Text="{Binding Device.DeviceInfo.AppVersion}"
                                       FontSize="14"
                                       TextColor="Black"/>
                            </Grid>
                        </VerticalStackLayout>
                    </Frame>

                    <!-- Remote Controls Section -->
                    <Frame Padding="16"
                           BackgroundColor="White"
                           BorderColor="{StaticResource LightGray}"
                           CornerRadius="8"
                           HasShadow="True">
                        <VerticalStackLayout Spacing="16">
                            <Label Text="Remote Controls"
                                   FontSize="20"
                                   FontAttributes="Bold"
                                   TextColor="Black"/>

                            <Grid RowDefinitions="Auto,Auto,Auto,Auto"
                                  ColumnDefinitions="*,*"
                                  RowSpacing="12"
                                  ColumnSpacing="12">

                                <!-- Restart Button (full width) -->
                                <Button Grid.Row="0" Grid.ColumnSpan="2"
                                        Text="Restart Device"
                                        Command="{Binding RestartCommand}"
                                        BackgroundColor="{StaticResource Danger}"
                                        TextColor="White"
                                        FontAttributes="Bold"
                                        HeightRequest="50"
                                        CornerRadius="8"/>

                                <!-- Volume Controls -->
                                <Button Grid.Row="1" Grid.Column="0"
                                        Text="Volume Up"
                                        Command="{Binding VolumeUpCommand}"
                                        BackgroundColor="{StaticResource Primary}"
                                        TextColor="White"
                                        HeightRequest="50"
                                        CornerRadius="8"/>
                                <Button Grid.Row="1" Grid.Column="1"
                                        Text="Volume Down"
                                        Command="{Binding VolumeDownCommand}"
                                        BackgroundColor="{StaticResource Primary}"
                                        TextColor="White"
                                        HeightRequest="50"
                                        CornerRadius="8"/>

                                <!-- Screen Controls -->
                                <Button Grid.Row="2" Grid.Column="0"
                                        Text="Screen On"
                                        Command="{Binding ScreenOnCommand}"
                                        BackgroundColor="{StaticResource Success}"
                                        TextColor="White"
                                        HeightRequest="50"
                                        CornerRadius="8"/>
                                <Button Grid.Row="2" Grid.Column="1"
                                        Text="Screen Off"
                                        Command="{Binding ScreenOffCommand}"
                                        BackgroundColor="#757575"
                                        TextColor="White"
                                        HeightRequest="50"
                                        CornerRadius="8"/>

                                <!-- Refresh Button (full width) -->
                                <Button Grid.Row="3" Grid.ColumnSpan="2"
                                        Text="Refresh Info"
                                        Command="{Binding RefreshCommand}"
                                        BackgroundColor="White"
                                        TextColor="{StaticResource Primary}"
                                        BorderColor="{StaticResource Primary}"
                                        BorderWidth="2"
                                        HeightRequest="50"
                                        CornerRadius="8"/>
                            </Grid>
                        </VerticalStackLayout>
                    </Frame>

                    <!-- Screenshot Section -->
                    <Frame Padding="16"
                           BackgroundColor="White"
                           BorderColor="{StaticResource LightGray}"
                           CornerRadius="8"
                           HasShadow="True">
                        <VerticalStackLayout Spacing="16">
                            <Label Text="Screenshot"
                                   FontSize="20"
                                   FontAttributes="Bold"
                                   TextColor="Black"/>

                            <Button Text="Take Screenshot"
                                    Command="{Binding RequestScreenshotCommand}"
                                    BackgroundColor="{StaticResource Primary}"
                                    TextColor="White"
                                    FontAttributes="Bold"
                                    HeightRequest="50"
                                    CornerRadius="8"/>

                            <!-- Screenshot Loading -->
                            <ActivityIndicator IsRunning="{Binding IsLoadingScreenshot}"
                                              IsVisible="{Binding IsLoadingScreenshot}"
                                              Color="{StaticResource Primary}"
                                              HeightRequest="50"/>

                            <!-- Screenshot Image -->
                            <Frame Padding="0"
                                   IsVisible="{Binding ScreenshotImage, Converter={StaticResource IsNotNullConverter}}"
                                   BorderColor="{StaticResource LightGray}"
                                   CornerRadius="8"
                                   HasShadow="False">
                                <VerticalStackLayout Spacing="8">
                                    <Image Source="{Binding ScreenshotImage}"
                                           Aspect="AspectFit"
                                           HeightRequest="300"
                                           BackgroundColor="Black"/>
                                    <Label Text="{Binding ScreenshotTimestamp, StringFormat='Captured: {0:yyyy-MM-dd HH:mm:ss}'}"
                                           FontSize="12"
                                           TextColor="#999"
                                           HorizontalOptions="Center"
                                           Margin="0,0,0,8"/>
                                </VerticalStackLayout>
                            </Frame>

                            <!-- No Screenshot Placeholder -->
                            <Label Text="No screenshot available. Tap 'Take Screenshot' to capture the current screen."
                                   IsVisible="{Binding ScreenshotImage, Converter={StaticResource IsNullConverter}}"
                                   FontSize="14"
                                   TextColor="#999"
                                   HorizontalTextAlignment="Center"
                                   Margin="16"/>
                        </VerticalStackLayout>
                    </Frame>

                </VerticalStackLayout>
            </ScrollView>
        </Grid>
    </Grid>
</ContentPage>
