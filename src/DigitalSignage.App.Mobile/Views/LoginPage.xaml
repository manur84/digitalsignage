<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:viewmodels="clr-namespace:DigitalSignage.App.Mobile.ViewModels"
             xmlns:models="clr-namespace:DigitalSignage.App.Mobile.Models"
             x:Class="DigitalSignage.App.Mobile.Views.LoginPage"
             x:DataType="viewmodels:LoginViewModel"
             Title="{Binding Title}"
             BackgroundColor="{DynamicResource Background}">

    <ScrollView>
        <VerticalStackLayout Padding="24" Spacing="24">

            <!-- Logo and Header Section -->
            <VerticalStackLayout Spacing="16" Margin="0,32,0,0">
                <Image Source="digisign_logo.png"
                       HeightRequest="300"
                       HorizontalOptions="Center" />

                <Label Text="Digital Signage"
                       FontSize="28"
                       FontAttributes="Bold"
                       TextColor="{DynamicResource Gray900}"
                       HorizontalOptions="Center" />

                <Label Text="Connect to your server"
                       FontSize="15"
                       TextColor="{DynamicResource Gray600}"
                       HorizontalOptions="Center" />
            </VerticalStackLayout>

            <!-- Status Card -->
            <Frame BackgroundColor="{DynamicResource SurfaceVariant}"
                   BorderColor="Transparent"
                   Padding="16"
                   CornerRadius="12"
                   HasShadow="False">
                <Label Text="{Binding StatusMessage}"
                       FontSize="14"
                       TextColor="{DynamicResource Gray700}"
                       HorizontalTextAlignment="Center"
                       LineBreakMode="WordWrap" />
            </Frame>

            <!-- Auto Discovery Section -->
            <VerticalStackLayout Spacing="12">
                <Label Text="Auto Discovery"
                       FontSize="18"
                       FontAttributes="Bold"
                       TextColor="{DynamicResource Gray900}" />

                <Button Text="Scan for Servers"
                        Command="{Binding StartScanCommand}"
                        IsEnabled="{Binding IsScanning, Converter={StaticResource InvertedBoolConverter}}"
                        BackgroundColor="{DynamicResource Primary}"
                        TextColor="White"
                        FontSize="16"
                        FontAttributes="Bold"
                        HeightRequest="52"
                        CornerRadius="12"
                        Margin="0,4,0,0" />

                <Button Text="Stop Scanning"
                        Command="{Binding StopScanCommand}"
                        IsVisible="{Binding IsScanning}"
                        BackgroundColor="{DynamicResource Gray600}"
                        TextColor="White"
                        FontSize="16"
                        FontAttributes="Bold"
                        HeightRequest="52"
                        CornerRadius="12" />

                <ActivityIndicator IsRunning="{Binding IsScanning}"
                                  IsVisible="{Binding IsScanning}"
                                  Color="{DynamicResource Primary}"
                                  HeightRequest="32"
                                  Margin="0,8" />
            </VerticalStackLayout>

            <!-- Discovered Servers List -->
            <VerticalStackLayout Spacing="8">
                <Label Text="Available Servers"
                       FontSize="18"
                       FontAttributes="Bold"
                       TextColor="{DynamicResource Gray900}"
                       Margin="0,8,0,0" />

                <CollectionView ItemsSource="{Binding DiscoveredServers}"
                               SelectionMode="None"
                               HeightRequest="300">
                    <CollectionView.ItemTemplate>
                        <DataTemplate x:DataType="models:DiscoveredServer">
                            <Frame BackgroundColor="{DynamicResource Surface}"
                                   BorderColor="{DynamicResource Primary}"
                                   Padding="20"
                                   Margin="0,8,0,8"
                                   CornerRadius="12"
                                   HasShadow="True">
                                <Grid RowDefinitions="Auto,Auto,Auto" RowSpacing="10">
                                    <Label Text="{Binding DisplayName}"
                                           FontSize="17"
                                           FontAttributes="Bold"
                                           TextColor="{DynamicResource Gray900}"
                                           Grid.Row="0" />

                                    <Label Text="{Binding Description}"
                                           FontSize="14"
                                           TextColor="{DynamicResource Gray600}"
                                           Grid.Row="1" />

                                    <Button Text="Connect"
                                            Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:LoginViewModel}}, Path=ConnectToSelectedServerCommand}"
                                            CommandParameter="{Binding .}"
                                            BackgroundColor="{DynamicResource Primary}"
                                            TextColor="White"
                                            FontSize="16"
                                            FontAttributes="Bold"
                                            HeightRequest="52"
                                            CornerRadius="12"
                                            Grid.Row="2"
                                            Margin="0,8,0,0" />
                                </Grid>
                            </Frame>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                    <CollectionView.EmptyView>
                        <VerticalStackLayout Padding="32" Spacing="8">
                            <Label Text="No servers found"
                                   FontSize="15"
                                   FontAttributes="Bold"
                                   TextColor="{DynamicResource Gray500}"
                                   HorizontalOptions="Center" />
                            <Label Text="Make sure your server is running"
                                   FontSize="13"
                                   TextColor="{DynamicResource Gray400}"
                                   HorizontalOptions="Center" />
                        </VerticalStackLayout>
                    </CollectionView.EmptyView>
                </CollectionView>
            </VerticalStackLayout>

            <!-- Manual Entry Toggle -->
            <Button Text="Manual Connection"
                    Command="{Binding ToggleManualEntryCommand}"
                    BackgroundColor="Transparent"
                    TextColor="{DynamicResource Primary}"
                    FontSize="15"
                    FontAttributes="Bold"
                    Margin="0,16,0,0" />

            <!-- Manual Entry Section -->
            <VerticalStackLayout Spacing="12" IsVisible="{Binding ShowManualEntry}">
                <Label Text="Manual Connection"
                       FontSize="18"
                       FontAttributes="Bold"
                       TextColor="{DynamicResource Gray900}" />

                <Frame BackgroundColor="{DynamicResource Surface}"
                       BorderColor="{DynamicResource Gray200}"
                       Padding="4"
                       CornerRadius="12"
                       HasShadow="False">
                    <Entry Placeholder="Server URL (e.g., 192.168.1.100:8080)"
                           PlaceholderColor="{DynamicResource Gray400}"
                           Text="{Binding ManualServerUrl}"
                           TextColor="{DynamicResource Gray900}"
                           FontSize="15"
                           Keyboard="Url"
                           HeightRequest="48"
                           ClearButtonVisibility="WhileEditing" />
                </Frame>

                <Frame BackgroundColor="{DynamicResource Surface}"
                       BorderColor="{DynamicResource Gray200}"
                       Padding="4"
                       CornerRadius="12"
                       HasShadow="False">
                    <Entry Placeholder="Registration Token (optional)"
                           PlaceholderColor="{DynamicResource Gray400}"
                           Text="{Binding RegistrationToken}"
                           TextColor="{DynamicResource Gray900}"
                           FontSize="15"
                           IsPassword="True"
                           HeightRequest="48"
                           ClearButtonVisibility="WhileEditing" />
                </Frame>

                <Button Text="Connect"
                        Command="{Binding ConnectManuallyCommand}"
                        BackgroundColor="{DynamicResource Primary}"
                        TextColor="White"
                        FontSize="16"
                        FontAttributes="Bold"
                        HeightRequest="52"
                        CornerRadius="12"
                        Margin="0,4,0,0" />
            </VerticalStackLayout>

            <!-- Loading Overlay -->
            <ActivityIndicator IsRunning="{Binding IsBusy}"
                              IsVisible="{Binding IsBusy}"
                              Color="{DynamicResource Primary}"
                              HeightRequest="48"
                              Margin="0,16" />

            <!-- Spacer for bottom -->
            <BoxView HeightRequest="32" Color="Transparent" />

        </VerticalStackLayout>
    </ScrollView>

</ContentPage>
